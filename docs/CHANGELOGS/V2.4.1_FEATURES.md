# v2.4.1 - OAuth2 Authentication & HTTP/3 Support

**Target Release**: November 2025  
**Priority**: MEDIUM  
**Status**: Complete (16/16 features)

## Major Changes

### OAuth2 Integration

Added comprehensive OAuth2 authentication for protecting specific paths with industry-standard providers.

**New Module**: `waf/oauth2/oauth2.go`
- Standard OAuth2 authorization code flow
- CSRF protection via state parameter
- Secure session management
- Configurable session timeout
- Per-path protection rules
- Automatic token exchange
- Logout endpoint

**Supported Providers**:
- Google OAuth2
- GitHub OAuth
- Microsoft Azure AD
- Any OAuth2-compliant provider

**Configuration**:
```json
{
  "oauth2": {
    "enabled": false,
    "client_id": "",
    "client_secret": "",
    "auth_url": "https://accounts.google.com/o/oauth2/v2/auth",
    "token_url": "https://oauth2.googleapis.com/token",
    "redirect_url": "https://yourdomain.com/oauth2/callback",
    "scopes": ["openid", "email", "profile"],
    "protected_paths": ["/admin", "/api/protected"],
    "session_timeout": 3600
  }
}
```

**Environment Variables**:
- `OAUTH2_CLIENT_ID` - Client ID from provider
- `OAUTH2_CLIENT_SECRET` - Client secret
- `OAUTH2_AUTH_URL` - Provider authorization endpoint
- `OAUTH2_TOKEN_URL` - Provider token endpoint
- `OAUTH2_REDIRECT_URL` - Callback URL

### Integration

OAuth2 middleware integrated into main middleware chain:

```
Request → OAuth2 → Fingerprint → Challenge → WAF → Backend
```

Unauthenticated requests to protected paths redirect to OAuth2 provider.

### Security Features

- State parameter prevents CSRF
- Secure HTTP-only cookies
- SameSite=Lax attribute
- Session expiry enforcement
- In-memory token storage
- Automatic cleanup of expired sessions

### Endpoints

- `/oauth2/callback` - OAuth2 callback handler (auto-created)
- `/oauth2/logout` - Logout and session clear

## Previously Completed (v2.4.1)

### Advanced Features (14 completed)

1.  **JWT Token Validation** (`waf/jwt/`)
   - Token parsing and signature verification
   - Claims validation
   - Protected path middleware

2.  **Request Body Size Limits** (`waf/bodylimits/`)
   - Per-endpoint size validation
   - Path-based limits
   - Global and specific rules

3.  **Automatic IP Ban** (`waf/autoban/`)
   - Violation counter per IP
   - Threshold-based banning
   - Automatic cleanup

4.  **Rate Limit Exemptions** (`waf/exemptions/`)
   - IP/path whitelist
   - Bypass rate limits
   - Priority matching

5.  **URL Rewrite Rules** (`waf/rewrite/`)
   - Regex-based rewriting
   - Capture groups
   - Path normalization

6.  **Request/Response Headers** (`waf/headers/`)
   - Add/Set/Remove operations
   - Path-based rules
   - Request and response manipulation

7.  **CORS Policy** (`waf/cors/`)
   - Origin whitelist
   - Preflight handling
   - Configurable methods/headers

8.  **Brotli Compression** (`waf/compression/`)
   - Brotli and gzip support
   - Configurable compression level
   - Content-type filtering

9.  **Cache Control** (`waf/cache/`)
   - Per-path cache headers
   - Multiple directives
   - Pattern matching

10.  **Conditional Rate Limits** (`waf/conditional/`)
    - Time-based limits
    - Schedule support
    - Different limits by time window

11.  **HTTP/3 Support** (`waf/http3/`)
    - QUIC protocol listener on port 443
    - 0-RTT connection resumption
    - Alt-Svc header for protocol negotiation
    - TLS 1.3 with h3/h3-29 ALPN
    - Automatic fallback to HTTP/2
    - Configurable max streams and timeouts
    - Session keep-alive every 15 seconds
    - Datagram support disabled by default

## Documentation

- Added `docs/OAUTH2.md` with full setup guide
- Added `docs/HTTP3.md` with TLS requirements and client support
- Updated README.md with OAuth2 and HTTP/3 quick start
- Updated `config/features.json` with OAuth2 and HTTP/3 configuration
- Environment variable documentation

## Breaking Changes

None - fully backward compatible with v2.4.0

## Migration Guide

OAuth2 is disabled by default. To enable:

1. Configure OAuth2 provider (Google/GitHub/Microsoft)
2. Set environment variables for client credentials
3. Enable in features.json: `"oauth2": { "enabled": true }`
4. Configure protected paths
5. Restart RhinoWAF

No changes needed for existing deployments unless OAuth2 is desired.

## Performance Impact

- Minimal overhead when disabled
- Session lookups are in-memory (O(1))
- Automatic cleanup prevents memory bloat
- No impact on non-protected paths

## Testing

OAuth2 tested with:
- Google OAuth2 (openid, email, profile scopes)
- GitHub OAuth (user scope)
- Session management and expiry
- State parameter validation
- Logout flow

## Version History

- **v2.4.1** (November 2025): OAuth2 authentication, 15/16 features complete
- **v2.4.0** (October 2025): HTTP request smuggling detection
- **v2.3.2** (October 2025): Health endpoints and metrics
- **v2.3.1** (October 2025): Quality of life improvements
- **v2.3.0** (September 2025): Browser fingerprinting
